#!/bin/bash
#
# SLURM job script to run:
#   - Q2.7  (LLM training on Grimm corpus, 5 epochs with optimizations)
#   - Q2.8b (generation experiments via evaluate_generation.py)
#   - Q3.4d (Graph CNN and GAT training with TensorBoard logs)
#
# It relies on the Conda environment specified in:
#   assignment2/part3/dl2025_gpu.yml
# with environment name: dl2025
#
# Submit from your home or repo root, e.g.:
#   cd $HOME/uvadlc_practicals_2025
#   sbatch assignment2/run_q2_q3.job

#SBATCH --partition=gpu_mig
#SBATCH --gpus=1
#SBATCH --job-name=DL1_A2_Q2_Q3
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=9
#SBATCH --time=04:00:00
#SBATCH --output=slurm_output_q2_q3_%A.out

module purge
module load 2025
module load Anaconda3/2025.06-1

# Go to the repository root (adjust if your repo is elsewhere)
cd "$HOME/uvadlc_practicals_2025" || exit 1

echo "Current working directory: $(pwd)"

# Ensure the Conda env from assignment2/part3/dl2025_gpu.yml exists.
# This block is safe to run multiple times: it only creates the env if missing.
if ! conda env list | awk '{print $1}' | grep -qx dl2025; then
  echo "Conda env 'dl2025' not found. Creating it from assignment2/part3/dl2025_gpu.yml ..."
  conda env create -f assignment2/part3/dl2025_gpu.yml || {
    echo "Failed to create conda env 'dl2025' from dl2025_gpu.yml"
    exit 1
  }
else
  echo "Conda env 'dl2025' already exists. Using existing environment."
fi

source activate dl2025

echo "Python version in env:"
python --version

echo "==============================================================="
echo "Running run_q2_q3.sh (Q2.7, Q2.8b, Q3.4d)"
echo "==============================================================="

srun bash assignment2/run_q2_q3.sh


